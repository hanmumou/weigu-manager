<template>
  <div class="app-container">
    <el-tabs class="marketing-card" type="card">
      <el-tab-pane label="运动积分设置">
        <!-- 运动积分设置 -->
        <div class="marketing-table">
          <!-- 运动积分列表 -->
          <el-form :model="formData" hide-required-asterisk="true">
            <el-form-item label="上传图片:" required>
              <el-upload :show-file-list="false" :data="banner" :headers="GetToken()" :on-success="handleAvatarSuccess" :before-upload="beforeAvatarUpload" class="avatar-uploader" action="https://community.suokekj.com/api/images/upload">
                <img v-if="formData.banner_img" :src="formData.banner_img" class="avatar">
                <i v-else class="el-icon-plus avatar-uploader-icon"/>
              </el-upload>
            </el-form-item>
            <el-form-item label="运动步数：" required>
              <el-input v-model="formData.step_number" style="width:301px"/>
            </el-form-item>
            <el-form-item label="可兑换积分：" required>
              <el-input v-model="formData.integral" style="width:301px"/>
            </el-form-item>
            <el-form-item label="能否与储值卡同用：" required>
              <template>
                <el-radio v-model="formData.is_value_card" :label="1">能同时使用</el-radio>
                <el-radio v-model="formData.is_value_card" :label="0">不能同时使用</el-radio>
              </template>
            </el-form-item>
            <el-form-item label="能否与优惠券同用：" required>
              <template>
                <el-radio v-model="formData.is_coupon" :label="1">能同时使用</el-radio>
                <el-radio v-model="formData.is_coupon" :label="0">不能同时使用</el-radio>
              </template>
            </el-form-item>
            <el-form-item label="最低消费：" class="consumption-item" required>
              <el-input v-model="consumption_amount" style="width:300px"/>
            </el-form-item>
            <el-form-item label="可用积分数量：" required>
              <el-input v-model="using_integral" style="width:300px"/>
              <el-button type="primary" @click="addTable">增加</el-button>
            </el-form-item>
          </el-form>
          <!-- 运动积分表格 -->
          <el-table :data="formData.integralList" style="marginLeft:150px;width:43%;" border>
            <!-- 最低消费金额 -->
            <el-table-column label="最低消费金额" align="center" prop="consumption_amount"/>
            <!-- 可使用积分数 -->
            <el-table-column label="可使用积分数" align="center" prop="using_integral"/>
            <!-- 操作 -->
            <el-table-column label="操作" align="center">
              <template slot-scope="scope">
                <el-button type="danger" size="mini" @click="del(scope.$index,scope.row)">删除</el-button>
              </template>
            </el-table-column>
          </el-table>
          <el-form style="marginTop:20px;">
            <!-- 积分详情 -->
            <el-form-item label="积分详情：">
              <!-- 富文本编辑器 -->
              <tinymce ref="box" v-model="content"/>
            </el-form-item>
            <!-- 修改按钮保存 -->
            <el-button v-if="list" type="primary" round @click="updateRun(formData);">保存</el-button>
            <!-- 添加按钮保存 -->
            <el-button v-else type="primary" round @click="subRun(formData);">保存</el-button>
          </el-form>
        </div>
      </el-tab-pane>
      <!-- 用户积分明细 -->
      <el-tab-pane label="用户积分详情">
        <!-- 用户积分详情 -->
        <div class="runintegral">
          <el-form :inline="true" class="demo-form-inline">
            <!-- <el-radio :label="3" @change="toggleSelection(tableData3)">全选</el-radio> -->
            <el-button class="select-all" @click="toggleSelection(tableData3)">全选表格</el-button>
            <div class="export">
              <el-button size="medium" type="primary" @click="exportExcel">导出会员列表</el-button>
            </div>
            <el-form-item label="用户ID：">
              <el-input/>
            </el-form-item>
            <el-form-item label="用户姓名：">
              <el-input/>
            </el-form-item>
            <el-form-item label="用户电话：">
              <el-input/>
            </el-form-item>
            <el-button type="primary">查询</el-button>
          </el-form>
        </div>
        <!-- 用户积分详情表格 -->
        <el-table
          id="#exportexcel"
          ref="multipleTable"
          :xs="20"
          :data="tableData3"
          :row-class-name="tableRoWClassName"
          tooltip-effect="dark"
          border
          style="width: 88%"
          @selection-change="handleSelectionChange">
          <el-table-column
            type="selection"
            align="center"/>
          <el-table-column
            prop="name"
            label="用户ID"
            align="center"/>
          <el-table-column
            prop="name"
            label="微信昵称"
            align="center"/>
          <el-table-column
            prop="name"
            align="center"
            width="130"
            label="微信昵称"
            show-overflow-tooltip/>
          <el-table-column
            prop="phone"
            align="center"
            label="姓名"
            show-overflow-tooltip/>
          <el-table-column
            prop="address"
            align="center"
            label="电话"
            show-overflow-tooltip/>
          <el-table-column
            prop="address"
            align="center"
            label="运动步数"
            show-overflow-tooltip/>
          <el-table-column
            prop="phone"
            align="center"
            label="兑换积分"
            show-overflow-tooltip/>
          <el-table-column
            prop="phone"
            align="center"
            label="已使用积分"/>
          <el-table-column
            prop="phone"
            align="center"
            label="剩余积分"
            show-overflow-tooltip/>
          <el-table-column
            align="center"
            label="操作"
            show-overflow-tooltip>
            <el-button>清空</el-button>
          </el-table-column>
        </el-table>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>
<script>
import FileSaver from 'file-saver'
import XLSX from 'xlsx'
import tinymce from '@/components/tinymce'
import { getToken } from '@/utils/auth'
import { addmotor, motorlist, updatemotorlist } from '@/api/motor'
export default {
  components: { tinymce },
  data() {
    return {
      formData: {
        banner_img: '',
        step_number: '',
        integral: '',
        is_value_card: '',
        is_coupon: '',
        integralList: [
          { consumption_amount: '',
            using_integral: '' }
        ],
        explain: ''
      },
      consumption_amount: '',
      using_integral: '',
      headers: { // 图片请求头部
        Authorization: ''
      },
      banner: {
        dirname: 'companies',
        images: ''
      },
      content: '', // 富文本编辑器
      // 储蓄卡初始值
      valuecard: '',
      // 优惠券初始值
      coupon: '',
      tableData3: [{
        date: '2016-05-03',
        name: '王小虎',
        address: '河北省石家庄裕华区翟营南大街新界南楼801我真的真的很长很长',
        phone: '18888888888'
      }, {
        date: '2016-05-02',
        name: '王小虎',
        address: '上海市普陀区金沙江路 大大 弄',
        phone: '18888888888'
      }, {
        date: '2016-05-04',
        name: '王小虎',
        address: '上海市普陀区金沙江路 1518 弄',
        phone: '18888888888'
      }, {
        date: '2016-05-01',
        name: '王小虎',
        address: '上海市普陀区金沙江路 1518 弄',
        phone: '18888888888'
      }, {
        date: '2016-05-08',
        name: '王小虎',
        address: '上海市普陀区金沙江路 1518 弄',
        phone: '18888888888'
      }, {
        date: '2016-05-06',
        name: '王小虎',
        address: '上海市普陀区金沙江路 1518 弄',
        phone: '18888888888'
      }, {
        date: '2016-05-07',
        name: '王小虎',
        address: '上海市普陀区金沙江路 1518 弄',
        phone: '18888888888'
      }],
      multipleSelection: [],
      list: false, // 设置判断使用
      richtext: ''
    }
  },
  mounted() {
    // 获取运动积分列表
    this.getlist()
  },
  methods: {
    // 获取列表
    async getlist() {
      try {
        this.richtext = ''
        const res = await motorlist()
        console.log(res)
        this.formData = res.data[0]
        this.content = res.data[0].explain
        // 进行判断
        this.list = true
        // 把内容注入到富文本当中
        this.$refs.box.setContent(this.content)
      } catch (err) {
        console.log(err)
      }
    },
    // 添加提交
    async subRun(data) {
      const banner_img = data.banner_img
      console.log(banner_img)
      const step_number = data.step_number
      const integral = data.integral
      const is_value_card = data.is_value_card
      const is_coupon = data.is_coupon
      const integralList = JSON.stringify(data.integralList)
      // 获取富文本内容
      const content = this.content
      try {
        const res = await addmotor(banner_img, step_number, integral, is_value_card, is_coupon, integralList, content)
        console.log('添加提交', res)
        this.router.go(0)
        console.log(666)
      } catch (err) {
        console.log(err)
      }
    },
    // 修改提交
    async updateRun(data) {
      console.log(111)
      const id = this.formData.id
      const banner_img = data.banner_img
      const step_number = data.step_number
      const integral = data.integral
      const is_value_card = data.is_value_card
      const is_coupon = data.is_coupon
      const integralList = JSON.stringify(this.formData.integralList)
      const content = this.content
      try {
        const res = await updatemotorlist(id, banner_img, step_number, integral, is_value_card, is_coupon, integralList, content)
        console.log('res', res)
        console.log(888)
        if (res.status === 201) {
          this.$message({
            message: '修改成功',
            type: 'success'
          })
        }
      } catch (err) {
        console.log(err)
      }
    },
    // 增加最低消费
    addTable() {
      this.formData.integralList.push({
        'consumption_amount': this.consumption_amount,
        'using_integral': this.using_integral
      })
    },
    // 删除最低消费
    del(index, row) {
      this.formData.integralList.splice(index, 1)
    },
    // 上传图片成功后
    handleAvatarSuccess(res) {
      this.formData.banner_img = res.path
      console.log('图片路径', this.formData.banner_img)
    },
    // 图片上传获取到token
    GetToken() {
      const res = getToken()
      this.headers.Authorization = 'Bearer ' + res
      return this.headers
    },
    // 图片上传前
    beforeAvatarUpload(res) {
      this.banner['images'] = res
    },
    // 表格隔行显示不同颜色
    tableRoWClassName({ row, rowIndex }) {
      if ((rowIndex % 2) === 1) {
        return 'success-row'
      } else if ((rowIndex % 2) === 0) {
        return 'warning-row'
      }
    },
    // 会员列表的表格全选操作
    toggleviplist(rows) {
      if (rows) {
        rows.forEach(row => {
          this.$refs.multipleTable.toggleRowSelection(row)
        })
      } else {
        this.$refs.multipleTable.clearSelection()
      }
    },
    // 消费详情的表格全选操作
    toggleSelection(rows) {
      if (rows) {
        rows.forEach(row => {
          this.$refs.multipleTable.toggleRowSelection(row)
        })
      } else {
        this.$refs.multipleTable.clearSelection()
      }
    },
    handleSelectionChange(val) {
      this.multipleSelection = val
    },
    // 导出Excel
    exportExcel() {
      /* generate workbook object from table */
      const wb = XLSX.utils.table_to_book(document.getElementById('#exportexcel'))
      /* get binary string as output */
      const wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'array' })
      try {
        FileSaver.saveAs(new Blob([wbout], { type: 'application/octet-stream' }), '会员列表.xlsx')
      } catch (e) {
        if (typeof console !== 'undefined') {
          console.log(e, wbout)
        }
      }
      return wbout
    }
  }
}
</script>

<style>
/* 内容盒子 */
.marketing-table{
  margin-top: 30px;
}
/* 去除tab 标签边框 */
.marketing-card .el-tabs--card>.el-tabs__header .el-tabs__nav{
  border: 0px;
}
.marketing-card .el-tabs__header{
  border-bottom:20px solid rgb(48, 65, 86);
}
/* tab标签活动选项 */
.marketing-card .el-tabs__item.is-active{
  background:#FE4643;
  color:#000;
}
.marketing-card .el-tabs__item:hover{
  color:#409EFF;
}
/* tab标签初始化样式 */
.marketing-card .el-tabs__item{
  font-size: 0.8rem;
  width: 8.42rem;
  height: 2.76rem;
  text-align: center;
  line-height: 2.76rem;
  border-radius: 16px 16px 0px 0px;
  background-color: #676767;
  color: #fff;
  margin-right: 10px;
}

.export{
  display: inline;
}
/* 同意字体间距 */
.marketing-font{
  margin-left: 80px;
}
/* 运动积分设置 */
.marketing-upload{
}
/* 运动积分结束 */

/* 消费详情页开始 */
.runintegral{
  background-color: rgb(48, 65, 86);
  padding: 20px;
  width: 88%;
}
.runintegral .el-form-item__label{
  color:#fff;
}
.vipconsume-select{
  margin-left: 15.5%;
}
  .el-table .warning-row {
    background: oldlace;
  }
</style>

<style>
/* uplad上传样式 */
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 178px;
    height: 178px;
    line-height: 178px;
    text-align: center;
  }
  .avatar {
    width: 178px;
    height: 178px;
    display: block;
  }
  .el-tabs--card>.el-tabs__header .el-tabs__nav{
    border:0px;
  }
  .marketing-card .el-form-item__label{
    width:150px;
    text-align:right;
  }
  .marketing-card .tinymce-container{
    width:43%;
    margin-left:150px;
  }
 .marketing-card .mce-tinymce{
   min-width: 600px!important;
 }

</style>
